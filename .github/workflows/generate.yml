name: Generate Protobuf

on:
  push:
    branches:
      - main
    paths:
      - 'proto/**'
      - 'buf.yaml'
      - 'buf.gen.yaml'
      - '.github/workflows/generate.yml'

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Important pour pouvoir pusher le code généré

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- SETUP TOOLS ---
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Buf
        uses: bufbuild/buf-setup-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install protoc
        run: |
          PROTOC_VERSION=25.1
          curl -LO https://github.com/protocolbuffers/protobuf/releases/download/v${PROTOC_VERSION}/protoc-${PROTOC_VERSION}-linux-x86_64.zip
          sudo unzip -o protoc-${PROTOC_VERSION}-linux-x86_64.zip -d /usr/local bin/protoc
          sudo unzip -o protoc-${PROTOC_VERSION}-linux-x86_64.zip -d /usr/local 'include/*'
          rm protoc-${PROTOC_VERSION}-linux-x86_64.zip
          protoc --version

      # --- INSTALL PLUGINS ---
      - name: Install Go Plugins
        run: |
          go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
          go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest

      - name: Install Python Plugins
        run: |
          python -m pip install grpcio-tools mypy-protobuf
          # Trouver et lier le plugin gRPC Python
          GRPC_PLUGIN=$(find /opt/hostedtoolcache/Python -name "grpc_python_plugin" 2>/dev/null | head -n 1)
          if [ -z "$GRPC_PLUGIN" ]; then
            GRPC_PLUGIN=$(find ~/.local -name "grpc_python_plugin" 2>/dev/null | head -n 1)
          fi
          if [ -n "$GRPC_PLUGIN" ]; then
            sudo ln -sf "$GRPC_PLUGIN" /usr/local/bin/protoc-gen-grpc-python
          fi
          which protoc-gen-grpc-python || echo "Warning: grpc-python plugin not found"

      - name: Install TS Plugins
        run: |
          npm install -g ts-proto

      # --- CLEANUP OLD GEN ---
      - name: Clean gen folder
        run: rm -rf gen

      # --- GENERATE CODE ---
      - name: Run Buf Generate
        run: buf generate

      # --- PYTHON FIXES ---
      # Python a besoin de __init__.py dans chaque dossier pour importer les modules
      - name: Add __init__.py for Python
        run: |
          find gen/python -type d -exec touch {}/__init__.py \;

      # --- COMMIT & PUSH ---
      - name: Commit and Push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: auto-generate protobuf code [skip ci]"
          branch: main
          file_pattern: 'gen/**'